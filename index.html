<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Snapshot Selector</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(to bottom right, #eaf6ff, #ffffff);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
      }

      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .container {
        background: white;
        padding: 40px 30px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        max-width: 400px;
        width: 100%;
      }

      h2 {
        text-align: center;
        margin-bottom: 30px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
      }

      select {
        width: 100%;
        padding: 12px;
        margin-bottom: 20px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 16px;
      }

      .btn {
        display: block;
        width: 100%;
        padding: 14px;
        background: linear-gradient(to right, #007bff, #00bfff);
        color: white;
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 20px;
        text-decoration: none;
      }

      .training-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #007bff;
        border-radius: 25px;
        padding: 10px 20px;
        color: white;
        text-decoration: none;
        font-weight: bold;
      }

      .training-btn::before {
        content: "üé•";
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Select CRM Setup</h2>

      <form action="#" method="POST">
        <!-- <label for="branding">Select Branding Bundle</label>
        <select id="branding" name="branding">
          <option value="" disabled selected>-- Select --</option>
          <option value="basic">Basic Branding</option>
          <option value="premium">Premium Branding</option>
          <option value="custom">Custom Branding</option>
        </select>

        <label for="addons">Add-Ons</label>
        <select id="addons" name="addons">
          <option value="" disabled selected>-- Select --</option>
          <option value="sms">SMS Campaign</option>
          <option value="ai_bot">AI Chatbot</option>
          <option value="calendar">Calendar Setup</option>
        </select> -->

        <!-- <label for="subaccount">Select Sub-Account</label>
        <select id="subaccount" name="subaccount">
          <option value="" disabled selected>-- Select Sub-Account --</option>
        </select> -->

        <label for="snapshot">Select Snapshot</label>
        <select id="snapshot" name="snapshot">
          <option value="" disabled selected>-- Select Snapshot --</option>
        </select>
      </form>
      <button id="importBtn" class="training-btn">IMPORT NOW</button>
      <!-- <a
        href="https://yourtraininglink.com"
        target="_blank"
        class="training-btn"
        >Training</a
      > -->
    </div>

    <script>
      document
        .getElementById("importBtn")
        .addEventListener("click", function () {
          const importBtn = document.getElementById("importBtn");

          // const locationId = document.getElementById("subaccount").value;
          const snapshotId = document.getElementById("snapshot").value;

          if (!snapshotId) {
            alert("Please select both a sub-account and snapshot.");
            return;
          }

          // const now = new Date();
          // const timestamp = now.toLocaleString(); // e.g., "8/4/2025, 2:33:12 PM"

          // const nameWithTime = `Najeeb Test ${timestamp}`;
          // fetch(
          //   "https://services.leadconnectorhq.com/opportunities/nYZGQe04TtAic1BJxKko",
          //   {
          //     method: "PUT",
          //     headers: {
          //       Accept: "application/json",
          //       Authorization:
          //         "Bearer pit-c7ac3d7c-decb-4f2e-bf9f-526cc24eae51",
          //       Version: "2021-07-28",
          //       "Content-Type": "application/json",
          //     },
          //     body: JSON.stringify({
          //       name: nameWithTime,
          //     }),
          //   }
          // )
          //   .then((response) => {
          //     if (!response.ok) {
          //       throw new Error(
          //         "Request failed with status " + response.status
          //       );
          //     }
          //     return response.json();
          //   })
          //   .then((data) => {
          //     alert("Opportunity updated successfully!");
          //     console.log(data);
          //   })
          //   .catch((error) => {
          //     alert("Error: " + error.message);
          //     console.error(error);
          //   });

          // ‚úÖ Disable button + show spinner
          importBtn.disabled = true;
          const originalText = importBtn.innerHTML;
          importBtn.innerHTML = `<span class="loader"></span>Importing...`;

          setTimeout(() => {
            importBtn.disabled = false;
            importBtn.innerHTML = originalText;
            alert("‚úÖ Snapshot imported successfully!");
          }, 120000); // 2
        });

      const token =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjb21wYW55X2lkIjoiRU9STk1LUVVaMnYxMGpaQzNJOEgiLCJ2ZXJzaW9uIjoxLCJpYXQiOjE3NTU4MTE3NTE0OTMsInN1YiI6IllTUHVRbzIyWXh1YWRDS2lIbDhMIn0.xY54NA2nuK9aW-o4SduW17kNWscF2ifIGDyt1-m5i_U"; // üîê Replace with secure token

      const headers = {
        Authorization: `Bearer ${token}`,
        Accept: "application/json",
        "Content-Type": "application/json",
      };

      async function fetchLocations() {
        try {
          const res = await fetch("https://rest.gohighlevel.com/v1/locations", {
            headers,
          });

          if (!res.ok) throw new Error(`Locations fetch failed: ${res.status}`);

          const response = await res.json();
          const locations = response.locations; // ‚úÖ THIS IS THE FIX
          console.log("Fetched Locations:", locations);

          const dropdown = document.getElementById("subaccount");
          dropdown.innerHTML = `<option value="" disabled selected>-- Select Sub-Account --</option>`;

          locations.forEach((loc) => {
            const option = document.createElement("option");
            option.value = loc.id;

            const displayName =
              loc.name?.trim() ||
              `${loc.firstName || "Unknown"} ${loc.lastName || ""} (${
                loc.state || "Unknown State"
              })`;

            option.textContent = displayName;
            dropdown.appendChild(option);
          });
        } catch (error) {
          console.error("Error fetching locations:", error);
          alert("Failed to load sub-accounts.");
        }
      }

      async function fetchSnapshots() {
        try {
          const res = await fetch("https://rest.gohighlevel.com/v1/snapshots", {
            headers,
          });

          if (!res.ok) {
            const errorText = await res.text();
            console.error("Snapshot fetch failed:", res.status, errorText);
            throw new Error("Snapshot fetch failed");
          }

          const response = await res.json();
          const snapshots = response.snapshots; // ‚úÖ CORRECT ACCESS
          console.log("Fetched Snapshots:", snapshots);

          const dropdown = document.getElementById("snapshot");
          dropdown.innerHTML = `<option value="" disabled selected>-- Select Snapshot --</option>`;

          if (!snapshots.length) {
            dropdown.innerHTML += `<option disabled>No snapshots available</option>`;
            return;
          }

          snapshots.forEach((snap) => {
            const option = document.createElement("option");
            option.value = snap.id;
            option.textContent = snap.name;
            dropdown.appendChild(option);
          });
        } catch (error) {
          console.error("Error fetching snapshots:", error);
          alert("Failed to load snapshots.");
        }
      }

      async function importSnapshot() {
        const locationId = document.getElementById("subaccount").value;
        const snapshotId = document.getElementById("snapshot").value;

        if (!locationId || !snapshotId) {
          alert("Please select both a sub-account and snapshot.");
          return;
        }

        // try {
        //   const res = await fetch(
        //     `https://rest.gohighlevel.com/v1/locations/${locationId}/importSnapshot`,
        //     {
        //       method: "POST",
        //       headers,
        //       body: JSON.stringify({ snapshotId }),
        //     }
        //   );

        //   if (!res.ok) {
        //     throw new Error("Snapshot import failed: " + res.status);
        //   }

        //   alert("‚úÖ Snapshot imported successfully!");
        // } catch (err) {
        //   console.error(err);
        //   alert("‚ùå Snapshot import failed: " + err.message);
        // }
      }

      // Load on window ready
      window.onload = function () {
        // fetchLocations();
        fetchSnapshots();
      };

      // document
      //   .getElementById("importBtn")
      //   .addEventListener("click", importSnapshot);
    </script>
  </body>
</html>
